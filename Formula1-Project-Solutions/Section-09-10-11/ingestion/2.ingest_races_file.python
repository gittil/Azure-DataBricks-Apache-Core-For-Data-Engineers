{"version":"NotebookV1","origId":4277921907349101,"name":"2.ingest_races_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907349102,"guid":"151eb895-5d8e-4c31-9515-9588423b8966","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest races.csv file","commandVersion":7,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4a93c97b-5dfc-4d9f-af2e-c93b99314c5c"},{"version":"CommandV1","origId":4277921907349103,"guid":"bee21754-af13-45d1-b6e0-a6ec2729bb1f","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the CSV file using the spark dataframe reader API","commandVersion":19,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"dc39463b-a292-4690-8a4d-9c74e62867d6"},{"version":"CommandV1","origId":4277921907349104,"guid":"0e036760-71e6-47a1-900b-0e775c072735","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType, DateType","commandVersion":24,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"da74dd8f-1fa6-4ae5-8060-69e6b05cc1d6"},{"version":"CommandV1","origId":4277921907349105,"guid":"8220bd5f-b501-4078-906a-d238d58fbe11","subtype":"command","commandType":"auto","position":4.0,"command":"races_schema = StructType(fields=[StructField(\"raceId\", IntegerType(), False),\n                                  StructField(\"year\", IntegerType(), True),\n                                  StructField(\"round\", IntegerType(), True),\n                                  StructField(\"circuitId\", IntegerType(), True),\n                                  StructField(\"name\", StringType(), True),\n                                  StructField(\"date\", DateType(), True),\n                                  StructField(\"time\", StringType(), True),\n                                  StructField(\"url\", StringType(), True) \n])","commandVersion":125,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4763110e-96de-47bb-8117-822aaf308f35"},{"version":"CommandV1","origId":4277921907349106,"guid":"f900711c-e388-400b-9f01-292df9125f65","subtype":"command","commandType":"auto","position":5.0,"command":"races_df = spark.read \\\n.option(\"header\", True) \\\n.schema(races_schema) \\\n.csv(\"/mnt/formula1dl/raw/races.csv\")","commandVersion":39,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cc8aa92c-e29b-4e32-80d8-caf959924ba5"},{"version":"CommandV1","origId":4277921907349107,"guid":"04778efb-6aa6-47ed-907a-1697409942a9","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n##### Step 2 - Add ingestion date and race_timestamp to the dataframe","commandVersion":22,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3c859b14-6ddd-4ad6-9854-e72afd960a3a"},{"version":"CommandV1","origId":4277921907349108,"guid":"2c718ed4-db74-4da0-ab3b-603a377eaad8","subtype":"command","commandType":"auto","position":10.5,"command":"from pyspark.sql.functions import current_timestamp, to_timestamp, concat, col, lit","commandVersion":25,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8eb2e87e-37b9-4b0a-bdb4-e94035af0f84"},{"version":"CommandV1","origId":4277921907349109,"guid":"ff0d46dc-37f5-40cf-a6ee-c035f0b4823d","subtype":"command","commandType":"auto","position":11.0,"command":"races_with_timestamp_df = races_df.withColumn(\"ingestion_date\", current_timestamp()) \\\n                                  .withColumn(\"race_timestamp\", to_timestamp(concat(col('date'), lit(' '), col('time')), 'yyyy-MM-dd HH:mm:ss'))","commandVersion":77,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"372db527-5d23-488a-8d74-3041352a7e1b"},{"version":"CommandV1","origId":4277921907349110,"guid":"16adf708-a6e4-4186-8162-d9920ba38f5a","subtype":"command","commandType":"auto","position":13.0,"command":"%md\n##### Step 3 - Select only the columns required & rename as required","commandVersion":18,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6129c39e-3acb-49c7-ad46-bf3213ed928f"},{"version":"CommandV1","origId":4277921907349111,"guid":"c8d48b71-b09a-40fd-a1f0-9f9039f4e9c2","subtype":"command","commandType":"auto","position":14.0,"command":"races_selected_df = races_with_timestamp_df.select(col('raceId').alias('race_id'), col('year').alias('race_year'), \n                                                   col('round'), col('circuitId').alias('circuit_id'),col('name'), col('ingestion_date'), col('race_timestamp'))","commandVersion":73,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"860876a2-d9c5-4d85-bdfb-337abf0d6aff"},{"version":"CommandV1","origId":4277921907349112,"guid":"c98c47a1-02d1-4124-ad68-018cb569f2bc","subtype":"command","commandType":"auto","position":16.0,"command":"%md\n##### Write the output to processed container in parquet format","commandVersion":14,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c26280c6-7c41-4c3d-aca7-bfa3b6d79f1c"},{"version":"CommandV1","origId":4277921907349113,"guid":"2f648b93-bc89-4147-b715-6664db3ecd9f","subtype":"command","commandType":"auto","position":17.0,"command":"races_selected_df.write.mode('overwrite').partitionBy('race_year').parquet('/mnt/formula1dl/processed/races')","commandVersion":21,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a6eb08b1-7eb3-4b19-a98c-8b796244dff2"},{"version":"CommandV1","origId":4277921907349114,"guid":"ace40ed0-8b1e-446c-af81-556991e373cc","subtype":"command","commandType":"auto","position":20.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e09de7b1-cb98-42ea-8371-f0f41651ff3e"}],"dashboards":[],"guid":"8afabbcf-6a9a-415a-9ca8-56e93b89cae3","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":2}}
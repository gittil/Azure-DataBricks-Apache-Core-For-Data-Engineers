{"version":"NotebookV1","origId":4277921907349127,"name":"5.ingest_results_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907349128,"guid":"4132c8d7-3c94-4e36-8026-f3e91ca64c06","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest results.json file","commandVersion":10,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1d086d17-8f9f-4c81-8473-1e56668cbad9"},{"version":"CommandV1","origId":4277921907349129,"guid":"2598e73a-b705-49b5-af1d-5ad87ecfa561","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the JSON file using the spark dataframe reader API","commandVersion":21,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c10a9b41-e54b-4be3-9579-680b36628fdb"},{"version":"CommandV1","origId":4277921907349130,"guid":"60801238-211b-4d8a-b301-42d54d9c1b4f","subtype":"command","commandType":"auto","position":2.5,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType, FloatType","commandVersion":31,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"61fa87da-9c0b-4cad-be57-16705af9ca63"},{"version":"CommandV1","origId":4277921907349131,"guid":"60d3ce08-8e26-4509-91dc-be6168eb7355","subtype":"command","commandType":"auto","position":2.75,"command":"results_schema = StructType(fields=[StructField(\"resultId\", IntegerType(), False),\n                                    StructField(\"raceId\", IntegerType(), True),\n                                    StructField(\"driverId\", IntegerType(), True),\n                                    StructField(\"constructorId\", IntegerType(), True),\n                                    StructField(\"number\", IntegerType(), True),\n                                    StructField(\"grid\", IntegerType(), True),\n                                    StructField(\"position\", IntegerType(), True),\n                                    StructField(\"positionText\", StringType(), True),\n                                    StructField(\"positionOrder\", IntegerType(), True),\n                                    StructField(\"points\", FloatType(), True),\n                                    StructField(\"laps\", IntegerType(), True),\n                                    StructField(\"time\", StringType(), True),\n                                    StructField(\"milliseconds\", IntegerType(), True),\n                                    StructField(\"fastestLap\", IntegerType(), True),\n                                    StructField(\"rank\", IntegerType(), True),\n                                    StructField(\"fastestLapTime\", StringType(), True),\n                                    StructField(\"fastestLapSpeed\", FloatType(), True),\n                                    StructField(\"statusId\", StringType(), True)])","commandVersion":43,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"059a5f92-5e4d-4bc0-a45c-26ce6fd8feeb"},{"version":"CommandV1","origId":4277921907349132,"guid":"76bdf3aa-bf54-4175-a969-a745ce0b4ebc","subtype":"command","commandType":"auto","position":2.9375,"command":"results_df = spark.read \\\n.schema(results_schema) \\\n.json(\"/mnt/formula1dl/raw/results.json\")","commandVersion":37,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"fd8e1ade-2c64-4846-922c-22aac59174ab"},{"version":"CommandV1","origId":4277921907349133,"guid":"3c37ac53-8f9f-4846-8ab1-a16f394e1cbc","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n##### Step 2 - Rename columns and add new columns","commandVersion":62,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"11a12637-558c-4342-8375-821d65060739"},{"version":"CommandV1","origId":4277921907349134,"guid":"ae924a5d-d535-43e8-b7ce-3f1de013716c","subtype":"command","commandType":"auto","position":3.5,"command":"from pyspark.sql.functions import current_timestamp","commandVersion":22,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"78f1c5bd-fd4a-4d09-8dac-41435c117d5a"},{"version":"CommandV1","origId":4277921907349135,"guid":"f27fe448-068f-4eec-a4c9-48dae69a0c0a","subtype":"command","commandType":"auto","position":3.75,"command":"results_with_columns_df = results_df.withColumnRenamed(\"resultId\", \"result_id\") \\\n                                    .withColumnRenamed(\"raceId\", \"race_id\") \\\n                                    .withColumnRenamed(\"driverId\", \"driver_id\") \\\n                                    .withColumnRenamed(\"constructorId\", \"constructor_id\") \\\n                                    .withColumnRenamed(\"positionText\", \"position_text\") \\\n                                    .withColumnRenamed(\"positionOrder\", \"position_order\") \\\n                                    .withColumnRenamed(\"fastestLap\", \"fastest_lap\") \\\n                                    .withColumnRenamed(\"fastestLapTime\", \"fastest_lap_time\") \\\n                                    .withColumnRenamed(\"fastestLapSpeed\", \"fastest_lap_speed\") \\\n                                    .withColumn(\"ingestion_date\", current_timestamp()) ","commandVersion":217,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"50592917-97ec-4c67-b891-1027c955e066"},{"version":"CommandV1","origId":4277921907349136,"guid":"87854838-35ff-4274-8f79-cedb420c31e3","subtype":"command","commandType":"auto","position":4.0,"command":"%md\n##### Step 3 - Drop the unwanted column","commandVersion":31,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"70470f00-def4-4cf1-a883-1495b79bfa71"},{"version":"CommandV1","origId":4277921907349137,"guid":"fbaf730e-723a-40c7-83ac-a26effe7eebd","subtype":"command","commandType":"auto","position":4.25,"command":"from pyspark.sql.functions import col","commandVersion":2,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"38384750-83f9-4a39-8883-e65da4ca4465"},{"version":"CommandV1","origId":4277921907349138,"guid":"bb504a6b-6165-4ba1-ba6e-3f3559f05084","subtype":"command","commandType":"auto","position":4.5,"command":"results_final_df = results_with_columns_df.drop(col(\"statusId\"))","commandVersion":16,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"36dedb37-ac08-45c1-8935-b8bbd450e9a8"},{"version":"CommandV1","origId":4277921907349139,"guid":"0e59e4b5-aea3-4fad-be5d-7665cd8b91e1","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n##### Step 4 - Write to output to processed container in parquet format","commandVersion":23,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2322063f-9693-4033-b70d-df6091c05224"},{"version":"CommandV1","origId":4277921907349140,"guid":"570c3fe9-1692-4fde-ac9f-f8fa0b4a7531","subtype":"command","commandType":"auto","position":6.0,"command":"results_final_df.write.mode(\"overwrite\").partitionBy('race_id').parquet(\"/mnt/formula1dl/processed/results\")","commandVersion":41,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1800a861-9f54-459c-a37d-d020a761991b"},{"version":"CommandV1","origId":4277921907349141,"guid":"23f45b74-841d-4cdd-83c5-4310544def61","subtype":"command","commandType":"auto","position":8.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b352a725-a812-4941-8aec-3d6f3c631b63"}],"dashboards":[],"guid":"ca19ac06-96a2-4d72-96a0-4d99dc21ff6a","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":2}}
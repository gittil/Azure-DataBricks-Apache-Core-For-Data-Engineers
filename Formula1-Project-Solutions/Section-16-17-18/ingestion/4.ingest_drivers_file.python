{"version":"NotebookV1","origId":4277921907349486,"name":"4.ingest_drivers_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907349487,"guid":"4c591b75-1283-4311-89c5-0d6cbdaecf0a","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest drivers.json file","commandVersion":9,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1d086d17-8f9f-4c81-8473-1e56668cbad9"},{"version":"CommandV1","origId":4277921907349488,"guid":"2d6c7f91-2c60-47f7-9c65-bd633bd8c77d","subtype":"command","commandType":"auto","position":1.25,"command":"dbutils.widgets.text(\"p_data_source\", \"\")\nv_data_source = dbutils.widgets.get(\"p_data_source\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c80e0870-c8d2-458e-b4b2-bdbdc6118011"},{"version":"CommandV1","origId":4277921907349489,"guid":"a668ea0e-2495-465b-aa5e-2745543cdaad","subtype":"command","commandType":"auto","position":1.5,"command":"%run \"../includes/configuration\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a7e9c040-0243-49e9-af89-9d8fe6232cd2"},{"version":"CommandV1","origId":4277921907349490,"guid":"fb4788b4-98dc-4cec-8b90-7da90cdacd0a","subtype":"command","commandType":"auto","position":1.75,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3fc88b3f-0ddd-4445-b01e-856f59948d28"},{"version":"CommandV1","origId":4277921907349491,"guid":"86ab6010-720f-46a3-8d29-529edec79c5e","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the JSON file using the spark dataframe reader API","commandVersion":21,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c10a9b41-e54b-4be3-9579-680b36628fdb"},{"version":"CommandV1","origId":4277921907349494,"guid":"506e4c24-b8e5-46a6-ac0f-597736bd59d2","subtype":"command","commandType":"auto","position":2.5,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType, DateType","commandVersion":26,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"61fa87da-9c0b-4cad-be57-16705af9ca63"},{"version":"CommandV1","origId":4277921907349495,"guid":"5807d485-84c7-4006-8382-37f66d4150eb","subtype":"command","commandType":"auto","position":2.75,"command":"name_schema = StructType(fields=[StructField(\"forename\", StringType(), True),\n                                 StructField(\"surname\", StringType(), True)\n  \n])","commandVersion":38,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"059a5f92-5e4d-4bc0-a45c-26ce6fd8feeb"},{"version":"CommandV1","origId":4277921907349496,"guid":"d1f4cf00-a156-4fd8-801b-19428c69dc83","subtype":"command","commandType":"auto","position":2.875,"command":"drivers_schema = StructType(fields=[StructField(\"driverId\", IntegerType(), False),\n                                    StructField(\"driverRef\", StringType(), True),\n                                    StructField(\"number\", IntegerType(), True),\n                                    StructField(\"code\", StringType(), True),\n                                    StructField(\"name\", name_schema),\n                                    StructField(\"dob\", DateType(), True),\n                                    StructField(\"nationality\", StringType(), True),\n                                    StructField(\"url\", StringType(), True)  \n])","commandVersion":104,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c5cd27f0-2243-4d6f-bf9c-520953037d60"},{"version":"CommandV1","origId":4277921907349497,"guid":"442db9a3-7a82-4a5a-a514-a36a34bfa749","subtype":"command","commandType":"auto","position":2.9375,"command":"drivers_df = spark.read \\\n.schema(drivers_schema) \\\n.json(f\"{raw_folder_path}/drivers.json\")","commandVersion":33,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"fd8e1ade-2c64-4846-922c-22aac59174ab"},{"version":"CommandV1","origId":4277921907349498,"guid":"bad4b887-030e-42cc-bbfa-9f3194b2c1ef","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n##### Step 2 - Rename columns and add new columns\n1. driverId renamed to driver_id  \n1. driverRef renamed to driver_ref  \n1. ingestion date added\n1. name added with concatenation of forename and surname","commandVersion":59,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"11a12637-558c-4342-8375-821d65060739"},{"version":"CommandV1","origId":4277921907349499,"guid":"b8344549-3572-4739-b7ca-22ae7063dc3a","subtype":"command","commandType":"auto","position":3.5,"command":"from pyspark.sql.functions import col, concat, lit","commandVersion":20,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"78f1c5bd-fd4a-4d09-8dac-41435c117d5a"},{"version":"CommandV1","origId":4277921907349500,"guid":"c9c02fce-5edc-469a-90c3-347db550b4a7","subtype":"command","commandType":"auto","position":3.625,"command":"drivers_with_ingestion_date_df = add_ingestion_date(drivers_df)","commandVersion":7,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"506aa21d-841e-47b3-8a54-a43b3d36aac5"},{"version":"CommandV1","origId":4277921907349501,"guid":"7755083d-aaea-4b24-966d-1adf5a5d0619","subtype":"command","commandType":"auto","position":3.75,"command":"drivers_with_columns_df = drivers_with_ingestion_date_df.withColumnRenamed(\"driverId\", \"driver_id\") \\\n                                    .withColumnRenamed(\"driverRef\", \"driver_ref\") \\\n                                    .withColumn(\"name\", concat(col(\"name.forename\"), lit(\" \"), col(\"name.surname\"))) \\\n                                    .withColumn(\"data_source\", lit(v_data_source))","commandVersion":166,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"50592917-97ec-4c67-b891-1027c955e066"},{"version":"CommandV1","origId":4277921907349502,"guid":"1fc6e7db-16f2-4b59-8993-076d55e1158c","subtype":"command","commandType":"auto","position":4.0,"command":"%md\n##### Step 3 - Drop the unwanted columns\n1. name.forename\n1. name.surname\n1. url","commandVersion":29,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"70470f00-def4-4cf1-a883-1495b79bfa71"},{"version":"CommandV1","origId":4277921907349503,"guid":"44d5d769-dc89-44b6-a81e-1dcb8566ab69","subtype":"command","commandType":"auto","position":4.5,"command":"drivers_final_df = drivers_with_columns_df.drop(col(\"url\"))","commandVersion":11,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"36dedb37-ac08-45c1-8935-b8bbd450e9a8"},{"version":"CommandV1","origId":4277921907349504,"guid":"6fbca7da-3900-4241-95b9-dabcb077c7bd","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n##### Step 4 - Write to output to processed container in parquet format","commandVersion":23,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2322063f-9693-4033-b70d-df6091c05224"},{"version":"CommandV1","origId":4277921907349505,"guid":"fba999b4-988b-4e1e-9c7f-d9817abcf1e0","subtype":"command","commandType":"auto","position":6.0,"command":"drivers_final_df.write.mode(\"overwrite\").format(\"parquet\").saveAsTable(\"f1_processed.drivers\")","commandVersion":27,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1800a861-9f54-459c-a37d-d020a761991b"},{"version":"CommandV1","origId":4277921907349506,"guid":"739ec915-688e-4338-87a7-22f5ab8c0768","subtype":"command","commandType":"auto","position":8.0,"command":"dbutils.notebook.exit(\"Success\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f419bed4-f221-4b82-bb70-952c73bacf26"}],"dashboards":[],"guid":"2ccaa499-7892-442d-8557-ae3018c49153","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_data_source":{"nuid":"66ae09a1-b1e1-43e7-9c72-95bc03775125","currentValue":"","widgetInfo":{"widgetType":"text","name":"p_data_source","defaultValue":"","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
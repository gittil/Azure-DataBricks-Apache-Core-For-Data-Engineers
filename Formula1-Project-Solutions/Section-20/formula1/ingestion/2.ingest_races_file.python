{"version":"NotebookV1","origId":4277921907350038,"name":"2.ingest_races_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907350039,"guid":"48baa8f3-d061-4ed1-8a5b-49c03d78b643","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest races.csv file","commandVersion":7,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4a93c97b-5dfc-4d9f-af2e-c93b99314c5c"},{"version":"CommandV1","origId":4277921907350040,"guid":"7624181d-c46d-4859-ab11-6cb9ce7a520b","subtype":"command","commandType":"auto","position":1.25,"command":"dbutils.widgets.text(\"p_data_source\", \"\")\nv_data_source = dbutils.widgets.get(\"p_data_source\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ddb90e0c-0dae-4be6-bc03-a0d8a5b61eb4"},{"version":"CommandV1","origId":4277921907350041,"guid":"72a64c74-b0b0-495c-9bde-7f63c398db85","subtype":"command","commandType":"auto","position":1.375,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-21\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"34c590b6-0b03-4e8d-ba48-18ca621f7ec5"},{"version":"CommandV1","origId":4277921907350042,"guid":"25288c79-e0fc-4d9d-b213-187d34e9b942","subtype":"command","commandType":"auto","position":1.5,"command":"%run \"../includes/configuration\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0c64c68e-0d9f-4db5-b4c3-fcc5dd0c3d10"},{"version":"CommandV1","origId":4277921907350043,"guid":"ed50e1b6-a413-4bdf-987c-60f1a0b32c18","subtype":"command","commandType":"auto","position":1.75,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e6d4b62d-0d4e-4e05-918b-9300bca13263"},{"version":"CommandV1","origId":4277921907350046,"guid":"4cf88798-9707-4d77-9ad3-3b0f9a1b1e0d","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the CSV file using the spark dataframe reader API","commandVersion":19,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"dc39463b-a292-4690-8a4d-9c74e62867d6"},{"version":"CommandV1","origId":4277921907350050,"guid":"6286f3ab-47e5-4fa7-a07e-93fa940f87c8","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType, DateType","commandVersion":24,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"da74dd8f-1fa6-4ae5-8060-69e6b05cc1d6"},{"version":"CommandV1","origId":4277921907350051,"guid":"b8294e54-201d-4fe4-87ba-e34add161791","subtype":"command","commandType":"auto","position":4.0,"command":"races_schema = StructType(fields=[StructField(\"raceId\", IntegerType(), False),\n                                  StructField(\"year\", IntegerType(), True),\n                                  StructField(\"round\", IntegerType(), True),\n                                  StructField(\"circuitId\", IntegerType(), True),\n                                  StructField(\"name\", StringType(), True),\n                                  StructField(\"date\", DateType(), True),\n                                  StructField(\"time\", StringType(), True),\n                                  StructField(\"url\", StringType(), True) \n])","commandVersion":125,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4763110e-96de-47bb-8117-822aaf308f35"},{"version":"CommandV1","origId":4277921907350052,"guid":"5baee1fb-4b9d-476a-9795-c76549036297","subtype":"command","commandType":"auto","position":5.0,"command":"races_df = spark.read \\\n.option(\"header\", True) \\\n.schema(races_schema) \\\n.csv(f\"{raw_folder_path}/{v_file_date}/races.csv\")","commandVersion":45,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cc8aa92c-e29b-4e32-80d8-caf959924ba5"},{"version":"CommandV1","origId":4277921907350053,"guid":"b9f3bd7c-f7b3-4c71-a8ed-058447248da0","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n##### Step 2 - Add ingestion date and race_timestamp to the dataframe","commandVersion":22,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3c859b14-6ddd-4ad6-9854-e72afd960a3a"},{"version":"CommandV1","origId":4277921907350054,"guid":"a3c64240-865e-474d-9dc0-37d088958d3c","subtype":"command","commandType":"auto","position":10.5,"command":"from pyspark.sql.functions import to_timestamp, concat, col, lit","commandVersion":26,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8eb2e87e-37b9-4b0a-bdb4-e94035af0f84"},{"version":"CommandV1","origId":4277921907350055,"guid":"cfb381ff-e4b7-49d2-b2ac-f29d801c5008","subtype":"command","commandType":"auto","position":11.0,"command":"races_with_timestamp_df = races_df.withColumn(\"race_timestamp\", to_timestamp(concat(col('date'), lit(' '), col('time')), 'yyyy-MM-dd HH:mm:ss')) \\\n.withColumn(\"data_source\", lit(v_data_source)) \\\n.withColumn(\"file_date\", lit(v_file_date))","commandVersion":86,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"372db527-5d23-488a-8d74-3041352a7e1b"},{"version":"CommandV1","origId":4277921907350056,"guid":"e528224b-8126-4ced-9196-b8bfb2fb9222","subtype":"command","commandType":"auto","position":12.0,"command":"races_with_ingestion_date_df = add_ingestion_date(races_with_timestamp_df)","commandVersion":5,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"417f6743-e88e-4822-9344-e830e8c88691"},{"version":"CommandV1","origId":4277921907350057,"guid":"34193c21-5863-46d7-9bf6-e3aecd8c9637","subtype":"command","commandType":"auto","position":13.0,"command":"%md\n##### Step 3 - Select only the columns required & rename as required","commandVersion":18,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6129c39e-3acb-49c7-ad46-bf3213ed928f"},{"version":"CommandV1","origId":4277921907350058,"guid":"abe443c4-51c5-4370-bd64-84e6823adced","subtype":"command","commandType":"auto","position":14.0,"command":"races_selected_df = races_with_ingestion_date_df.select(col('raceId').alias('race_id'), col('year').alias('race_year'), \n                                                   col('round'), col('circuitId').alias('circuit_id'),col('name'), col('ingestion_date'), col('race_timestamp'))","commandVersion":74,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"860876a2-d9c5-4d85-bdfb-337abf0d6aff"},{"version":"CommandV1","origId":4277921907350059,"guid":"b1aac018-ef10-417c-9b47-56b52a2e0f8b","subtype":"command","commandType":"auto","position":16.0,"command":"%md\n##### Write the output to processed container in parquet format","commandVersion":14,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c26280c6-7c41-4c3d-aca7-bfa3b6d79f1c"},{"version":"CommandV1","origId":4277921907350060,"guid":"3aa465e4-4c2b-4bfc-92dc-0811d39e772c","subtype":"command","commandType":"auto","position":17.0,"command":"races_selected_df.write.mode(\"overwrite\").partitionBy('race_year').format(\"delta\").saveAsTable(\"f1_processed.races\")","commandVersion":67,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a6eb08b1-7eb3-4b19-a98c-8b796244dff2"},{"version":"CommandV1","origId":4277921907350061,"guid":"3bc6cfe3-d23d-48af-b801-fb2f8f2b6eef","subtype":"command","commandType":"auto","position":18.5,"command":"%sql\nSELECT * FROM f1_processed.races;","commandVersion":4,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"1144","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"22c4eb50-e34a-436b-b74a-ff5e67a74f2c"},{"version":"CommandV1","origId":4277921907350062,"guid":"78eea7f7-b2c1-435a-852e-dfe3789245b5","subtype":"command","commandType":"auto","position":20.0,"command":"dbutils.notebook.exit(\"Success\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"25a6f976-59cd-4c5d-aba2-e5fcb326f883"}],"dashboards":[],"guid":"56189b78-48a3-4119-9deb-7a8316907c46","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_data_source":{"nuid":"8da587aa-3345-455c-bc95-21344ab54495","currentValue":"","widgetInfo":{"widgetType":"text","name":"p_data_source","defaultValue":"","label":null,"options":{"widgetType":"text","validationRegex":null}}},"p_file_date":{"nuid":"de4b2b44-0aaf-470e-a964-ebb9990171ce","currentValue":"2021-03-21","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-21","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
{"version":"NotebookV1","origId":4277921907350113,"name":"6.ingest_pit_stops_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907350114,"guid":"d3478684-8b0a-4160-a32c-50e3379eb34b","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest pit_stops.json file","commandVersion":13,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1d086d17-8f9f-4c81-8473-1e56668cbad9"},{"version":"CommandV1","origId":4277921907350115,"guid":"2074cd7c-a154-4a4a-b674-9639fa7289b7","subtype":"command","commandType":"auto","position":1.25,"command":"dbutils.widgets.text(\"p_data_source\", \"\")\nv_data_source = dbutils.widgets.get(\"p_data_source\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ccb88611-c557-4c0b-9daf-f525f5d45fb6"},{"version":"CommandV1","origId":4277921907350116,"guid":"7a619a42-2a25-4df7-a674-4e199b6b3259","subtype":"command","commandType":"auto","position":1.375,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-28\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"797d8733-e7b2-4502-9a48-b151245ce871"},{"version":"CommandV1","origId":4277921907350117,"guid":"b4bd32e2-9465-40b5-ae32-321a40764fb2","subtype":"command","commandType":"auto","position":1.5,"command":"%run \"../includes/configuration\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a8cf65f9-ca3c-40c1-ad62-25506e583f92"},{"version":"CommandV1","origId":4277921907350118,"guid":"e1930bc2-d8b7-45c5-8b0e-4d9dcdb249ff","subtype":"command","commandType":"auto","position":1.75,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"fee364e9-d24b-4021-96f0-9b6d235d10dd"},{"version":"CommandV1","origId":4277921907350121,"guid":"002ca8f4-bb31-4c5d-adbc-4a9e8632549a","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the JSON file using the spark dataframe reader API","commandVersion":21,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c10a9b41-e54b-4be3-9579-680b36628fdb"},{"version":"CommandV1","origId":4277921907350125,"guid":"fdb73cdf-c681-49c7-af5b-fe876357032c","subtype":"command","commandType":"auto","position":2.5,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType","commandVersion":26,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e96f6f6e-23b4-400b-a056-1a6acb01c9ab"},{"version":"CommandV1","origId":4277921907350127,"guid":"38b936c0-906a-48a0-aadd-5221a03af3cc","subtype":"command","commandType":"auto","position":2.75,"command":"pit_stops_schema = StructType(fields=[StructField(\"raceId\", IntegerType(), False),\n                                      StructField(\"driverId\", IntegerType(), True),\n                                      StructField(\"stop\", StringType(), True),\n                                      StructField(\"lap\", IntegerType(), True),\n                                      StructField(\"time\", StringType(), True),\n                                      StructField(\"duration\", StringType(), True),\n                                      StructField(\"milliseconds\", IntegerType(), True)\n                                     ])","commandVersion":60,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c3a4491a-b952-4196-969b-bf5c7965b4b0"},{"version":"CommandV1","origId":4277921907350128,"guid":"3a11335e-7a66-44bd-bed5-8e278634a782","subtype":"command","commandType":"auto","position":2.875,"command":"pit_stops_df = spark.read \\\n.schema(pit_stops_schema) \\\n.option(\"multiLine\", True) \\\n.json(f\"{raw_folder_path}/{v_file_date}/pit_stops.json\")","commandVersion":49,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"03a2f953-b4a0-46f0-880e-ed3bfd3b1b1a"},{"version":"CommandV1","origId":4277921907350129,"guid":"ffdea78e-8c6e-4e1b-866e-ed0bfa119ffc","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n##### Step 2 - Rename columns and add new columns\n1. Rename driverId and raceId\n1. Add ingestion_date with current timestamp","commandVersion":82,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"11a12637-558c-4342-8375-821d65060739"},{"version":"CommandV1","origId":4277921907350130,"guid":"0ad5c46a-630f-4de7-a2b8-3b7931c8f7c1","subtype":"command","commandType":"auto","position":3.75,"command":"pit_stops_with_ingestion_date_df = add_ingestion_date(pit_stops_df)","commandVersion":8,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f912fbc0-9a0d-4586-b6fc-a11d3767f762"},{"version":"CommandV1","origId":4277921907350131,"guid":"325f8ffe-2678-409a-9ed9-f864fe5c1867","subtype":"command","commandType":"auto","position":3.875,"command":"from pyspark.sql.functions import lit","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"84f06840-eb81-40db-84ab-5cda6c92ebd1"},{"version":"CommandV1","origId":4277921907350132,"guid":"8899cc25-5323-4b46-a63d-0f10fd72d0c9","subtype":"command","commandType":"auto","position":4.0,"command":"final_df = pit_stops_with_ingestion_date_df.withColumnRenamed(\"driverId\", \"driver_id\") \\\n.withColumnRenamed(\"raceId\", \"race_id\") \\\n.withColumn(\"ingestion_date\", current_timestamp()) \\\n.withColumn(\"data_source\", lit(v_data_source)) \\\n.withColumn(\"file_date\", lit(v_file_date))","commandVersion":53,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3f9f833e-aee5-47df-b553-da43dbefc16b"},{"version":"CommandV1","origId":4277921907350133,"guid":"e58bf724-48de-407d-afac-e803fb09865a","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n##### Step 3 - Write to output to processed container in parquet format","commandVersion":26,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2322063f-9693-4033-b70d-df6091c05224"},{"version":"CommandV1","origId":4277921907350134,"guid":"a0bcc40d-606c-482c-a4ff-114cd061ad38","subtype":"command","commandType":"auto","position":7.625,"command":"#overwrite_partition(final_df, 'f1_processed', 'pit_stops', 'race_id')","commandVersion":31,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"714fd8bf-b2a4-4221-819b-e6ac1a40a89d"},{"version":"CommandV1","origId":4277921907350135,"guid":"4a5609f5-28fe-4769-9eeb-4e5014c167ea","subtype":"command","commandType":"auto","position":8.8125,"command":"merge_condition = \"tgt.race_id = src.race_id AND tgt.driver_id = src.driver_id AND tgt.stop = src.stop AND tgt.race_id = src.race_id\"\nmerge_delta_data(final_df, 'f1_processed', 'pit_stops', processed_folder_path, merge_condition, 'race_id')","commandVersion":30,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"53958353-e406-4822-8dbf-3c7e5c2fc3c7"},{"version":"CommandV1","origId":4277921907350136,"guid":"40f473ee-7e0a-435f-be86-3fb6045ea6cf","subtype":"command","commandType":"auto","position":10.0,"command":"dbutils.notebook.exit(\"Success\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"340c1b9e-7494-4b2c-bbfc-09074ddeadc6"},{"version":"CommandV1","origId":4277921907350137,"guid":"f62af50a-7c6f-403b-ab6f-8c34c2f008a7","subtype":"command","commandType":"auto","position":11.0,"command":"%sql\nSELECT * FROM f1_processed.pit_stops;","commandVersion":11,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"1227","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"35abe572-54bd-49b7-8756-5502abd26ea6"},{"version":"CommandV1","origId":4277921907350138,"guid":"ae7d5717-c049-4891-8cca-a67d1711c4c2","subtype":"command","commandType":"auto","position":12.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f992bb88-8332-41e8-afd3-28da0ed534dd"}],"dashboards":[],"guid":"6d34615f-6546-4a69-9e73-bd814ba25554","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_data_source":{"nuid":"e593fd36-4778-4daa-b594-c095b1021b4b","currentValue":"","widgetInfo":{"widgetType":"text","name":"p_data_source","defaultValue":"","label":null,"options":{"widgetType":"text","validationRegex":null}}},"p_file_date":{"nuid":"6cfa4885-3815-4a9e-9eed-342fcbb9c2c1","currentValue":"2021-04-18","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-28","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
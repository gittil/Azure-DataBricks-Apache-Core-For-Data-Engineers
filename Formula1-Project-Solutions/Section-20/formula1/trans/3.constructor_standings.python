{"version":"NotebookV1","origId":4277921907350288,"name":"3.constructor_standings","language":"python","commands":[{"version":"CommandV1","origId":4277921907350289,"guid":"27c72cc0-457d-4790-bee9-bedf92cbda95","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n##### Produce constructor standings","commandVersion":14,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ad999ff7-73cf-4179-8e32-24d79b9fa48d"},{"version":"CommandV1","origId":4277921907350290,"guid":"236bc5c8-8e15-454e-b708-a475655c1beb","subtype":"command","commandType":"auto","position":1.5,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-28\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"9cdb80a8-2882-44d6-aa18-bfec603b0b71"},{"version":"CommandV1","origId":4277921907350291,"guid":"acbe9b7e-15cd-4b0a-9f18-c7705c5a28a9","subtype":"command","commandType":"auto","position":2.0,"command":"%run \"../includes/configuration\"","commandVersion":3,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"07fa1800-f6d6-4241-a087-17856cd53788"},{"version":"CommandV1","origId":4277921907350293,"guid":"4dee9fce-f47b-44b3-98f2-2701485b613c","subtype":"command","commandType":"auto","position":2.5,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8af5376d-a1b6-4516-b518-e6fea51d51a4"},{"version":"CommandV1","origId":4277921907350295,"guid":"0a83aef9-4618-426e-afae-9801c35c53fc","subtype":"command","commandType":"auto","position":2.75,"command":"%md\nFind race years for which the data is to be reprocessed","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4ee2c868-c3fb-41e1-a99e-c520e6824f89"},{"version":"CommandV1","origId":4277921907350297,"guid":"95036c52-3051-4568-a210-882848ea33c5","subtype":"command","commandType":"auto","position":2.875,"command":"race_results_df = spark.read.format(\"delta\").load(f\"{presentation_folder_path}/race_results\") \\\n.filter(f\"file_date = '{v_file_date}'\") ","commandVersion":16,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ea1e7237-5627-4646-9af0-6bd000b46ffc"},{"version":"CommandV1","origId":4277921907350298,"guid":"ff2fb9a7-651b-4cae-8eea-db104956af3d","subtype":"command","commandType":"auto","position":2.8828125,"command":"race_year_list = df_column_to_list(race_results_df, 'race_year')","commandVersion":12,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e39affc8-76a3-4df7-9ab5-5eb705229826"},{"version":"CommandV1","origId":4277921907350300,"guid":"9f3beb12-412e-4a41-8d59-0c5e198ffb17","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.functions import col\n\nrace_results_df = spark.read.format(\"delta\").load(f\"{presentation_folder_path}/race_results\") \\\n.filter(col(\"race_year\").isin(race_year_list))","commandVersion":29,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"74794080-479c-47ad-9035-2ef75f11e7ad"},{"version":"CommandV1","origId":4277921907350303,"guid":"a78f6605-aa1c-4a1c-81b7-436c4f615121","subtype":"command","commandType":"auto","position":5.0,"command":"from pyspark.sql.functions import sum, when, count, col\n\nconstructor_standings_df = race_results_df \\\n.groupBy(\"race_year\", \"team\") \\\n.agg(sum(\"points\").alias(\"total_points\"),\n     count(when(col(\"position\") == 1, True)).alias(\"wins\"))","commandVersion":89,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ca0e5172-8580-4466-aad8-8e9bec268963"},{"version":"CommandV1","origId":4277921907350304,"guid":"9d384a54-30a2-4d32-b140-ba6672ca39bd","subtype":"command","commandType":"auto","position":9.0,"command":"from pyspark.sql.window import Window\nfrom pyspark.sql.functions import desc, rank, asc\n\nconstructor_rank_spec = Window.partitionBy(\"race_year\").orderBy(desc(\"total_points\"), desc(\"wins\"))\nfinal_df = constructor_standings_df.withColumn(\"rank\", rank().over(constructor_rank_spec))","commandVersion":69,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5ddc0607-f2c7-43bb-9000-47052da113ec"},{"version":"CommandV1","origId":4277921907350305,"guid":"f4df8b62-ecdc-40da-8055-81097a5f5d10","subtype":"command","commandType":"auto","position":12.0,"command":"merge_condition = \"tgt.team = src.team AND tgt.race_year = src.race_year\"\nmerge_delta_data(final_df, 'f1_presentation', 'constructor_standings', presentation_folder_path, merge_condition, 'race_year')","commandVersion":4,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3d18f44c-26aa-4b7c-8913-2fcdb2ace4e8"},{"version":"CommandV1","origId":4277921907350306,"guid":"20e85a25-635a-4c51-89c6-8641b1468fa4","subtype":"command","commandType":"auto","position":13.0,"command":"%sql\nSELECT * FROM f1_presentation.constructor_standings WHERE race_year = 2021;","commandVersion":2,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"599","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8bad41be-a6c9-4cdc-9e27-a3ae23cc7d90"},{"version":"CommandV1","origId":4277921907350307,"guid":"7cd57956-20b6-486b-a09d-7d390689cc0e","subtype":"command","commandType":"auto","position":14.0,"command":"%sql\nSELECT race_year, COUNT(1)\n  FROM f1_presentation.constructor_standings\n GROUP BY race_year\n ORDER BY race_year DESC;","commandVersion":2,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"270","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"1c967c35-de7a-4605-abaa-88a0d39f8885"}],"dashboards":[],"guid":"3f667cdb-299a-46e0-9a0b-2f7349815ddc","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_file_date":{"nuid":"ae9f0000-9edd-4d9a-8441-12be2cbba015","currentValue":"2021-04-18","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-28","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
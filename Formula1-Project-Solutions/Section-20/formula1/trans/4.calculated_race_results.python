{"version":"NotebookV1","origId":4277921907350259,"name":"4.calculated_race_results","language":"python","commands":[{"version":"CommandV1","origId":4277921907350260,"guid":"428a0db2-30e7-4d05-a996-4e5ef6699836","subtype":"command","commandType":"auto","position":1.5,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-21\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b4e6c5da-64d3-4138-ae08-dae28039c47d"},{"version":"CommandV1","origId":4277921907350261,"guid":"acbe6047-7fed-481c-a83e-b9aa43c66880","subtype":"command","commandType":"auto","position":2.25,"command":"spark.sql(f\"\"\"\n              CREATE TABLE IF NOT EXISTS f1_presentation.calculated_race_results\n              (\n              race_year INT,\n              team_name STRING,\n              driver_id INT,\n              driver_name STRING,\n              race_id INT,\n              position INT,\n              points INT,\n              calculated_points INT,\n              created_date TIMESTAMP,\n              updated_date TIMESTAMP\n              )\n              USING DELTA\n\"\"\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e09be349-3195-404f-8669-c003760c0fb7"},{"version":"CommandV1","origId":4277921907350262,"guid":"64f73968-0e02-46de-8a0d-c15f38166344","subtype":"command","commandType":"auto","position":2.625,"command":"spark.sql(f\"\"\"\n              CREATE OR REPLACE TEMP VIEW race_result_updated\n              AS\n              SELECT races.race_year,\n                     constructors.name AS team_name,\n                     drivers.driver_id,\n                     drivers.name AS driver_name,\n                     races.race_id,\n                     results.position,\n                     results.points,\n                     11 - results.position AS calculated_points\n                FROM f1_processed.results \n                JOIN f1_processed.drivers ON (results.driver_id = drivers.driver_id)\n                JOIN f1_processed.constructors ON (results.constructor_id = constructors.constructor_id)\n                JOIN f1_processed.races ON (results.race_id = races.race_id)\n               WHERE results.position <= 10\n                 AND results.file_date = '{v_file_date}'\n\"\"\")","commandVersion":85,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"78ae7d09-211e-40ac-a8c8-e4fd6146a0a7"},{"version":"CommandV1","origId":4277921907350263,"guid":"e848250a-89f6-4e0c-8a5f-cc88bce953e9","subtype":"command","commandType":"auto","position":3.015625,"command":"spark.sql(f\"\"\"\n              MERGE INTO f1_presentation.calculated_race_results tgt\n              USING race_result_updated upd\n              ON (tgt.driver_id = upd.driver_id AND tgt.race_id = upd.race_id)\n              WHEN MATCHED THEN\n                UPDATE SET tgt.position = upd.position,\n                           tgt.points = upd.points,\n                           tgt.calculated_points = upd.calculated_points,\n                           tgt.updated_date = current_timestamp\n              WHEN NOT MATCHED\n                THEN INSERT (race_year, team_name, driver_id, driver_name,race_id, position, points, calculated_points, created_date ) \n                     VALUES (race_year, team_name, driver_id, driver_name,race_id, position, points, calculated_points, current_timestamp)\n       \"\"\")","commandVersion":13,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"63a25156-979d-455a-ae59-3ab42167f6fc"},{"version":"CommandV1","origId":4277921907350264,"guid":"77937e31-a7ae-4efa-a11b-fc0dc0c54391","subtype":"command","commandType":"auto","position":4.015625,"command":"%sql\nSELECT COUNT(1) FROM race_result_updated;","commandVersion":8,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"270","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7bbef695-8418-4fba-b249-f04355e2e8c9"},{"version":"CommandV1","origId":4277921907350265,"guid":"8fefbe67-56d0-434b-8329-218761d62e15","subtype":"command","commandType":"auto","position":5.015625,"command":"%sql\nSELECT COUNT(1) FROM f1_presentation.calculated_race_results;","commandVersion":6,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"270","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ccded44d-a28d-4ef3-a278-13a0570f9c57"},{"version":"CommandV1","origId":4277921907350266,"guid":"e3867dbf-6664-47a6-870c-35497fc4c252","subtype":"command","commandType":"auto","position":6.015625,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"98e5b031-d6a3-4626-9e64-01de16096518"}],"dashboards":[],"guid":"d474458b-a521-4622-ac11-c19e7f61bdda","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_file_date":{"nuid":"e5bef487-cb93-459a-a714-c965c07adab3","currentValue":"2021-04-18","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-21","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
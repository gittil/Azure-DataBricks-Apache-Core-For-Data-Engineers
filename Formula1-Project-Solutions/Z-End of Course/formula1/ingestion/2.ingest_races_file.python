{"version":"NotebookV1","origId":4277921907351338,"name":"2.ingest_races_file","language":"python","commands":[{"version":"CommandV1","origId":4277921907351339,"guid":"dacf8b7c-9247-4dd6-8552-fd2108857614","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n### Ingest races.csv file","commandVersion":7,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4a93c97b-5dfc-4d9f-af2e-c93b99314c5c"},{"version":"CommandV1","origId":4277921907351340,"guid":"85676ee8-0cc2-447f-ae89-9557943aabcb","subtype":"command","commandType":"auto","position":1.25,"command":"dbutils.widgets.text(\"p_data_source\", \"\")\nv_data_source = dbutils.widgets.get(\"p_data_source\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ddb90e0c-0dae-4be6-bc03-a0d8a5b61eb4"},{"version":"CommandV1","origId":4277921907351341,"guid":"bc7d820d-410a-458a-a5da-a4346ca831ec","subtype":"command","commandType":"auto","position":1.375,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-21\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"34c590b6-0b03-4e8d-ba48-18ca621f7ec5"},{"version":"CommandV1","origId":4277921907351342,"guid":"93bfeef0-8dcf-404f-9223-140e207a9f84","subtype":"command","commandType":"auto","position":1.5,"command":"%run \"../includes/configuration\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0c64c68e-0d9f-4db5-b4c3-fcc5dd0c3d10"},{"version":"CommandV1","origId":4277921907351343,"guid":"233ce989-6fd2-467a-b9e1-d63fbc70d49e","subtype":"command","commandType":"auto","position":1.75,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e6d4b62d-0d4e-4e05-918b-9300bca13263"},{"version":"CommandV1","origId":4277921907351344,"guid":"98057c85-63e5-45c4-9aed-ad26150391d8","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n##### Step 1 - Read the CSV file using the spark dataframe reader API","commandVersion":19,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"dc39463b-a292-4690-8a4d-9c74e62867d6"},{"version":"CommandV1","origId":4277921907351345,"guid":"362ab66f-b592-437b-9867-01e770759815","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.types import StructType, StructField, IntegerType, StringType, DateType","commandVersion":24,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"da74dd8f-1fa6-4ae5-8060-69e6b05cc1d6"},{"version":"CommandV1","origId":4277921907351346,"guid":"e5d7e5ae-1597-44bd-b99f-a7dfc3e342e1","subtype":"command","commandType":"auto","position":4.0,"command":"races_schema = StructType(fields=[StructField(\"raceId\", IntegerType(), False),\n                                  StructField(\"year\", IntegerType(), True),\n                                  StructField(\"round\", IntegerType(), True),\n                                  StructField(\"circuitId\", IntegerType(), True),\n                                  StructField(\"name\", StringType(), True),\n                                  StructField(\"date\", DateType(), True),\n                                  StructField(\"time\", StringType(), True),\n                                  StructField(\"url\", StringType(), True) \n])","commandVersion":125,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4763110e-96de-47bb-8117-822aaf308f35"},{"version":"CommandV1","origId":4277921907351347,"guid":"cb4d6960-cc14-4b71-a0d6-60497f8638fd","subtype":"command","commandType":"auto","position":5.0,"command":"races_df = spark.read \\\n.option(\"header\", True) \\\n.schema(races_schema) \\\n.csv(f\"{raw_folder_path}/{v_file_date}/races.csv\")","commandVersion":45,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"cc8aa92c-e29b-4e32-80d8-caf959924ba5"},{"version":"CommandV1","origId":4277921907351348,"guid":"2a3f5565-3182-4b25-8c77-ca8d1020640f","subtype":"command","commandType":"auto","position":10.0,"command":"%md\n##### Step 2 - Add ingestion date and race_timestamp to the dataframe","commandVersion":22,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3c859b14-6ddd-4ad6-9854-e72afd960a3a"},{"version":"CommandV1","origId":4277921907351349,"guid":"48421de0-ec9f-4d77-9104-d136470a831e","subtype":"command","commandType":"auto","position":10.5,"command":"from pyspark.sql.functions import to_timestamp, concat, col, lit","commandVersion":26,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8eb2e87e-37b9-4b0a-bdb4-e94035af0f84"},{"version":"CommandV1","origId":4277921907351350,"guid":"302b2af0-381a-4240-bf64-d9dc0c22188b","subtype":"command","commandType":"auto","position":11.0,"command":"races_with_timestamp_df = races_df.withColumn(\"race_timestamp\", to_timestamp(concat(col('date'), lit(' '), col('time')), 'yyyy-MM-dd HH:mm:ss')) \\\n.withColumn(\"data_source\", lit(v_data_source)) \\\n.withColumn(\"file_date\", lit(v_file_date))","commandVersion":86,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"372db527-5d23-488a-8d74-3041352a7e1b"},{"version":"CommandV1","origId":4277921907351351,"guid":"37f3ac03-f262-4a73-99e8-45119aec994b","subtype":"command","commandType":"auto","position":12.0,"command":"races_with_ingestion_date_df = add_ingestion_date(races_with_timestamp_df)","commandVersion":5,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"417f6743-e88e-4822-9344-e830e8c88691"},{"version":"CommandV1","origId":4277921907351352,"guid":"51373fb7-0ddd-47ed-8bed-19e11d4d2b05","subtype":"command","commandType":"auto","position":13.0,"command":"%md\n##### Step 3 - Select only the columns required & rename as required","commandVersion":18,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"6129c39e-3acb-49c7-ad46-bf3213ed928f"},{"version":"CommandV1","origId":4277921907351353,"guid":"e909bc88-13e3-42cd-a658-a0a7ec6db9e3","subtype":"command","commandType":"auto","position":14.0,"command":"races_selected_df = races_with_ingestion_date_df.select(col('raceId').alias('race_id'), col('year').alias('race_year'), \n                                                   col('round'), col('circuitId').alias('circuit_id'),col('name'), col('ingestion_date'), col('race_timestamp'))","commandVersion":74,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"860876a2-d9c5-4d85-bdfb-337abf0d6aff"},{"version":"CommandV1","origId":4277921907351354,"guid":"2f3e4fed-45e7-4284-a306-5c15ac9f9471","subtype":"command","commandType":"auto","position":16.0,"command":"%md\n##### Write the output to processed container in parquet format","commandVersion":14,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c26280c6-7c41-4c3d-aca7-bfa3b6d79f1c"},{"version":"CommandV1","origId":4277921907351355,"guid":"47900c43-f565-42f6-9963-5d272e37e194","subtype":"command","commandType":"auto","position":17.0,"command":"races_selected_df.write.mode(\"overwrite\").partitionBy('race_year').format(\"delta\").saveAsTable(\"f1_processed.races\")","commandVersion":67,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a6eb08b1-7eb3-4b19-a98c-8b796244dff2"},{"version":"CommandV1","origId":4277921907351356,"guid":"0dcf503a-c32c-4f55-bd85-d02e328b24a8","subtype":"command","commandType":"auto","position":18.5,"command":"%sql\nSELECT * FROM f1_processed.races;","commandVersion":4,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"1144","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"22c4eb50-e34a-436b-b74a-ff5e67a74f2c"},{"version":"CommandV1","origId":4277921907351357,"guid":"10408f2f-d432-4d82-85c2-9d94bef2458d","subtype":"command","commandType":"auto","position":20.0,"command":"dbutils.notebook.exit(\"Success\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"25a6f976-59cd-4c5d-aba2-e5fcb326f883"}],"dashboards":[],"guid":"ca11fa23-7c78-4380-8873-bf3f83e9d454","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_data_source":{"nuid":"8da587aa-3345-455c-bc95-21344ab54495","currentValue":"","widgetInfo":{"widgetType":"text","name":"p_data_source","defaultValue":"","label":null,"options":{"widgetType":"text","validationRegex":null}}},"p_file_date":{"nuid":"de4b2b44-0aaf-470e-a964-ebb9990171ce","currentValue":"2021-03-21","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-21","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}
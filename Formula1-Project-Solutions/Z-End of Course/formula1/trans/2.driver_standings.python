{"version":"NotebookV1","origId":4277921907351774,"name":"2.driver_standings","language":"python","commands":[{"version":"CommandV1","origId":4277921907351775,"guid":"3039a00c-8dcf-4459-8de7-6c6524e07aea","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n##### Produce driver standings","commandVersion":10,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ad999ff7-73cf-4179-8e32-24d79b9fa48d"},{"version":"CommandV1","origId":4277921907351776,"guid":"f5f23022-c640-4c44-b8fc-f19a3e34b6fb","subtype":"command","commandType":"auto","position":1.25,"command":"dbutils.widgets.text(\"p_file_date\", \"2021-03-28\")\nv_file_date = dbutils.widgets.get(\"p_file_date\")","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"f47e712e-8478-4bf1-b7ea-3a125a161a13"},{"version":"CommandV1","origId":4277921907351777,"guid":"c299abdd-4159-4037-a81f-abbd86a08965","subtype":"command","commandType":"auto","position":1.5,"command":"%run \"../includes/common_functions\"","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"affbeca8-ce54-4418-8f02-47c047ee36f2"},{"version":"CommandV1","origId":4277921907351778,"guid":"64e04903-79fc-4b6a-9d92-e1e39a9d6dcf","subtype":"command","commandType":"auto","position":2.0,"command":"%run \"../includes/configuration\"","commandVersion":3,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"07fa1800-f6d6-4241-a087-17856cd53788"},{"version":"CommandV1","origId":4277921907351779,"guid":"756f52ab-71ca-4c04-b3ff-9454d47598a4","subtype":"command","commandType":"auto","position":2.5,"command":"%md\nFind race years for which the data is to be reprocessed","commandVersion":12,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4aa55f8b-933b-4b73-ac72-641560e36b94"},{"version":"CommandV1","origId":4277921907351780,"guid":"2b7cf5f7-0442-4441-8561-ae7f55e23aec","subtype":"command","commandType":"auto","position":2.75,"command":"race_results_df = spark.read.format(\"delta\").load(f\"{presentation_folder_path}/race_results\") \\\n.filter(f\"file_date = '{v_file_date}'\") ","commandVersion":53,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7a2c004d-f4c7-43c8-906c-ce5be083cd07"},{"version":"CommandV1","origId":4277921907351781,"guid":"99874235-e0ca-473a-a1e4-6f7c0ae0a279","subtype":"command","commandType":"auto","position":2.84375,"command":"race_year_list = df_column_to_list(race_results_df, 'race_year')","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ee286c62-294c-4ee5-bd46-1e7038ea52b1"},{"version":"CommandV1","origId":4277921907351782,"guid":"40bd5153-e381-4259-b988-838c475453fd","subtype":"command","commandType":"auto","position":3.0,"command":"from pyspark.sql.functions import col\n\nrace_results_df = spark.read.format(\"delta\").load(f\"{presentation_folder_path}/race_results\") \\\n.filter(col(\"race_year\").isin(race_year_list))","commandVersion":58,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"74794080-479c-47ad-9035-2ef75f11e7ad"},{"version":"CommandV1","origId":4277921907351783,"guid":"10ef6b9d-a915-47d5-8c68-61c6a8f7598e","subtype":"command","commandType":"auto","position":5.0,"command":"from pyspark.sql.functions import sum, when, count, col\n\ndriver_standings_df = race_results_df \\\n.groupBy(\"race_year\", \"driver_name\", \"driver_nationality\") \\\n.agg(sum(\"points\").alias(\"total_points\"),\n     count(when(col(\"position\") == 1, True)).alias(\"wins\"))","commandVersion":92,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ca0e5172-8580-4466-aad8-8e9bec268963"},{"version":"CommandV1","origId":4277921907351784,"guid":"b6b282dd-ec3a-4fc1-8807-a8c6cecb6e37","subtype":"command","commandType":"auto","position":9.0,"command":"from pyspark.sql.window import Window\nfrom pyspark.sql.functions import desc, rank, asc\n\ndriver_rank_spec = Window.partitionBy(\"race_year\").orderBy(desc(\"total_points\"), desc(\"wins\"))\nfinal_df = driver_standings_df.withColumn(\"rank\", rank().over(driver_rank_spec))","commandVersion":66,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5ddc0607-f2c7-43bb-9000-47052da113ec"},{"version":"CommandV1","origId":4277921907351785,"guid":"104229f7-12e3-4c9c-ba81-fbfdb1dc918d","subtype":"command","commandType":"auto","position":14.0,"command":"merge_condition = \"tgt.driver_name = src.driver_name AND tgt.race_year = src.race_year\"\nmerge_delta_data(final_df, 'f1_presentation', 'driver_standings', presentation_folder_path, merge_condition, 'race_year')","commandVersion":5,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"697e5a0c-4d22-45b1-a127-86eee2159a81"},{"version":"CommandV1","origId":4277921907351786,"guid":"f6c605fc-9ff9-4a26-80e3-9b34767e89b8","subtype":"command","commandType":"auto","position":15.0,"command":"%sql\nSELECT * FROM f1_presentation.driver_standings WHERE race_year = 2021;","commandVersion":16,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"1029","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4792dfaa-1f9a-4ce4-a4b9-f3664e7beed7"},{"version":"CommandV1","origId":4277921907351787,"guid":"37f369bb-2348-4b9a-b9fa-9c918da71510","subtype":"command","commandType":"auto","position":16.0,"command":"%sql\nSELECT race_year, COUNT(1)\n  FROM f1_presentation.driver_standings\n GROUP BY race_year\n ORDER BY race_year DESC;","commandVersion":6,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"270","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"af0b22c5-9222-455a-b542-cc62a30410b0"},{"version":"CommandV1","origId":4277921907351788,"guid":"f3e15ee7-9575-42bf-b0cd-72d7efd1c24e","subtype":"command","commandType":"auto","position":17.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"25ed2bd2-b9b2-4227-a477-c7a8904653ab"}],"dashboards":[],"guid":"e8e2c39c-4b86-4415-ab1d-d7fa15910244","globalVars":{},"iPythonMetadata":null,"inputWidgets":{"p_file_date":{"nuid":"1daf985f-4221-4f37-9d06-bfa398ea9f1b","currentValue":"2021-04-18","widgetInfo":{"widgetType":"text","name":"p_file_date","defaultValue":"2021-03-28","label":null,"options":{"widgetType":"text","validationRegex":null}}}},"notebookMetadata":{"pythonIndentUnit":2}}